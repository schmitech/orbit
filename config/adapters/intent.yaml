# Intent Retriever Adapters
# These adapters use intent classification to generate queries from natural language
# Supports SQL, DuckDB, PostgreSQL, Elasticsearch, MongoDB, HTTP APIs, and Firecrawl

adapters:
  - name: "intent-sql-sqlite-hr"
    enabled: true
    type: "retriever"
    datasource: "sqlite"
    adapter: "intent"
    implementation: "retrievers.implementations.intent.IntentSQLiteRetriever"
    database: "utils/sql-intent-template/examples/sqlite/hr/hr.db"
    # Provider overrides - intent adapters benefit from powerful models
    inference_provider: "ollama_cloud"    # Cloud LLM for complex intent classification
    model: "gpt-oss:120b"           # Large model for better intent understanding
    embedding_provider: "ollama"          # Local embeddings for template matching
    # reranker_provider: "ollama"           # Optional: Jina AI reranker for template relevance
    capabilities:
      retrieval_behavior: "always"
      formatting_style: "standard"
      supports_file_ids: false
      supports_session_tracking: false
      supports_threading: true
      requires_api_key_validation: true
    config:
      # SQLite database path is configured in datasources.yaml
      check_same_thread: false  # Allow multi-threaded access

      # Path to the domain definition file
      domain_config_path: "utils/sql-intent-template/examples/sqlite/hr/hr-domain.yaml"
      template_library_path:
        - "utils/sql-intent-template/examples/sqlite/hr/hr-templates.yaml"

      # Name for the vector store collection for templates
      template_collection_name: "hr_intent_templates"
      # Store configuration - references stores.yaml
      store_name: "chroma"
      confidence_threshold: 0.4

      # Maximum templates to consider
      max_templates: 5

      # Return top N results
      return_results: 10

      # Template loading settings
      reload_templates_on_start: true  # Whether to reload templates on startup
      force_reload_templates: true  # Force reload even if templates exist in storage

      # Unified retriever features
      use_connection_pool: false  # SQLite doesn't support traditional pooling (file-based)
      pool_size: 1  # Not applicable for SQLite
      connection_timeout: 30  # Connection timeout in seconds

      # Query monitoring (automatically provided by unified base)
      enable_query_monitoring: true
      query_timeout: 5000  # 5 seconds

  - name: "intent-sql-sqlite-classified"
    enabled: false
    type: "retriever"
    datasource: "sqlite"
    adapter: "intent"
    implementation: "retrievers.implementations.intent.IntentSQLiteRetriever"
    database: "../demos/classified-data/classified_data.db"
    inference_provider: "ollama_cloud"
    model: "minimax-m2"
    embedding_provider: "ollama"
    embedding_model: "nomic-embed-text:latest"
    # reranker_provider: "cohere"
    config:
      # reranker_top_n: 10      # Optional: limit reranked results (overrides return_results)
      check_same_thread: false  # Allow multi-threaded access

      # Path to the domain definition file
      domain_config_path: "utils/sql-intent-template/examples/sqlite/classified-data/classified_data_domain.yaml"
      template_library_path:
        - "utils/sql-intent-template/examples/sqlite/classified-data/classified_data_templates.yaml"

      # Name for the vector store collection for templates
      template_collection_name: "classified_data_intent_templates"
      # Store configuration - references stores.yaml
      store_name: "chroma"
      confidence_threshold: 0.4

      # Maximum templates to consider
      max_templates: 5

      # Return top N results
      return_results: 100

      # Template loading settings
      reload_templates_on_start: false  # Whether to reload templates on startup
      force_reload_templates: false  # Force reload even if templates exist in storage

      # Unified retriever features
      use_connection_pool: false  # SQLite doesn't support traditional pooling (file-based)
      pool_size: 1  # Not applicable for SQLite
      connection_timeout: 30  # Connection timeout in seconds

      # Query monitoring (automatically provided by unified base)
      enable_query_monitoring: true
      query_timeout: 5000  # 5 seconds
  
  - name: "intent-duckdb-analytics"
    enabled: true
    type: "retriever"
    datasource: "duckdb"
    adapter: "intent"
    implementation: "retrievers.implementations.intent.IntentDuckDBRetriever"
    database: "utils/duckdb-intent-template/examples/analytics/analytics.duckdb"
    inference_provider: "ollama_cloud"
    model: "gpt-oss:120b"
    # embedding_provider: "openrouter"
    # embedding_model: "openai/text-embedding-3-small"
    embedding_provider: "ollama"
    embedding_model: "nomic-embed-text:latest"
    capabilities:
      retrieval_behavior: "always"
      formatting_style: "standard"
      supports_file_ids: false
      supports_session_tracking: false
      supports_threading: true
      supports_autocomplete: true  # Enable autocomplete from template nl_examples
      requires_api_key_validation: true
    config:
      # Path to the domain definition file
      domain_config_path: "utils/duckdb-intent-template/examples/analytics/analytics_domain.yaml"
      template_library_path:
        - "utils/duckdb-intent-template/examples/analytics/analytics_templates.yaml"

      # Name for the vector store collection for templates
      template_collection_name: "duckdb_analytics_templates"
      # Store configuration - references stores.yaml
      store_name: "chroma"
      confidence_threshold: 0.4

      # Maximum templates to consider
      max_templates: 5

      # Return top N results
      return_results: 100

      # Template loading settings
      reload_templates_on_start: false  # Whether to reload templates on startup
      force_reload_templates: false  # Force reload even if templates exist in storage

      # DuckDB-specific configuration
      # Database path is configured in datasources.yaml (defaults to examples/duckdb/analytics.duckdb)
      # Can override here if needed:
      # database: "path/to/custom.duckdb"  # Optional: override datasource default
      read_only: true  # Allow concurrent reads from multiple processes (no writes needed for intent queries)
      access_mode: "READ_ONLY"  # Multiple processes can read simultaneously (see https://duckdb.org/docs/stable/connect/concurrency)
      threads: null  # Use default thread count

      # Query monitoring (automatically provided by unified base)
      enable_query_monitoring: true
      query_timeout: 5000  # 5 seconds

  # Washington State Electric Vehicle Population Database
  # Data source: Washington State DOL via data.gov
  # Contains 270,000+ registered BEV and PHEV vehicles
  - name: "intent-duckdb-ev-population"
    enabled: true
    type: "retriever"
    datasource: "duckdb"
    adapter: "intent"
    implementation: "retrievers.implementations.intent.IntentDuckDBRetriever"
    database: "utils/duckdb-intent-template/examples/ev-population/ev_population.duckdb"
    inference_provider: "openai"
    model: "gpt-5.2"
    # embedding_provider: "openrouter"
    # embedding_model: "openai/text-embedding-3-small"
    embedding_provider: "ollama"
    embedding_model: "nomic-embed-text:latest"
    config:
      # Path to the domain definition file
      domain_config_path: "utils/duckdb-intent-template/examples/ev-population/ev_population_domain.yaml"
      template_library_path:
        - "utils/duckdb-intent-template/examples/ev-population/ev_population_templates.yaml"

      # Name for the vector store collection for templates
      template_collection_name: "duckdb_ev_population_templates"
      # Store configuration - references stores.yaml
      store_name: "chroma"
      confidence_threshold: 0.4

      # Maximum templates to consider
      max_templates: 5

      # Return top N results
      return_results: 100

      # Template loading settings
      reload_templates_on_start: true  # Reload templates on startup for new deployment
      force_reload_templates: true     # Force reload to pick up template changes

      # DuckDB-specific configuration
      read_only: true  # Allow concurrent reads from multiple processes
      access_mode: "READ_ONLY"  # Multiple processes can read simultaneously
      threads: null  # Use default thread count

      # Query monitoring (automatically provided by unified base)
      enable_query_monitoring: true
      query_timeout: 5000  # 5 seconds

  - name: "intent-sql-postgres"
    enabled: false
    type: "retriever"
    datasource: "postgres"
    adapter: "intent"
    implementation: "retrievers.implementations.intent.IntentPostgreSQLRetriever"
    inference_provider: "ollama_cloud"
    model: "gpt-oss:120b"
    embedding_provider: "ollama"
    embedding_model: "nomic-embed-text:latest"
    # reranker_provider: "cohere"

    # Capabilities: Standard intent retriever
    # Note: Intent adapters use the same capabilities as QA adapters (always retrieve, standard formatting)
    capabilities:
      retrieval_behavior: "always"       # Always retrieves matching intents/templates
      formatting_style: "standard"       # Standard format with citations and confidence scores
      supports_file_ids: false           # Does not support file filtering
      supports_session_tracking: false   # Does not need session tracking
      requires_api_key_validation: false # API key used for access control only
      optional_parameters:
        - "api_key"

    config:
      # Path to the domain definition file
      domain_config_path: "utils/sql-intent-template/examples/postgres/customer-orders/customer_order_domain.yaml"
      template_library_path:
        - "utils/sql-intent-template/examples/postgres/customer-orders/customer_orders_templates.yaml"
        - "utils/sql-intent-template/examples/postgres/customer-orders/business_intelligence_templates.yaml"
        - "utils/sql-intent-template/examples/postgres/customer-orders/advanced_analytics_templates.yaml"
        - "utils/sql-intent-template/examples/postgres/customer-orders/comparative_analysis_templates.yaml"
      # Name for the vector store collection for templates
      # reranker_top_n: 40      # Optional: limit reranked results (overrides return_results)
      template_collection_name: "intent_query_templates"
      # Store configuration - references stores.yaml
      store_name: "chroma"
      confidence_threshold: 0.4
      # Maximum templates to consider
      max_templates: 5
      # Return top N results
      return_results: 100

      # Template loading settings
      reload_templates_on_start: true  # Whether to reload templates on startup
      force_reload_templates: true  # Force reload even if templates exist in storage

      # Unified retriever features
      use_connection_pool: true  # Enable connection pooling
      pool_size: 5  # Connection pool size
      connection_timeout: 30  # Connection timeout in seconds

      # Query monitoring (automatically provided by new base)
      enable_query_monitoring: true
      query_timeout: 5000  # 5 seconds

  # Elasticsearch Intent Adapter - Application Logs
  # This adapter demonstrates Elasticsearch Query DSL generation from natural language
  # Connection parameters are inherited from config/datasources.yaml
  - name: "intent-elasticsearch-app-logs"
    enabled: false
    type: "retriever"
    datasource: "elasticsearch"  # References datasources.yaml elasticsearch config
    adapter: "intent"
    implementation: "retrievers.implementations.intent.IntentElasticsearchRetriever"
    inference_provider: "cohere"
    # model: "minimax-m2:cloud"
    embedding_provider: "ollama"
    embedding_model: "nomic-embed-text:latest"
    # reranker_provider: "ollama"
    config:
      # Domain and template configuration
      domain_config_path: "utils/elasticsearch-intent-template/examples/application-logs/templates/logs_domain.yaml"
      template_library_path:
        - "utils/elasticsearch-intent-template/examples/application-logs/templates/logs_templates.yaml"

      # reranker_top_n: 3      # Optional: limit reranked results (overrides return_results)
      # Vector store configuration for template matching
      template_collection_name: "elasticsearch_logs_templates"
      store_name: "chroma"  # References stores.yaml

      # Intent matching configuration
      confidence_threshold: 0.4
      max_templates: 5
      return_results: 10

      # Template loading settings
      reload_templates_on_start: false
      force_reload_templates: false

      # Elasticsearch-specific configuration
      # Note: Connection parameters (node, auth, verify_certs) are in datasources.yaml
      # Only adapter-specific settings go here
      index_pattern: "application-logs-demo"  # Default index pattern for queries
      use_query_dsl: true  # Enable Query DSL processing
      enable_aggregations: false  # Enable aggregation support
      enable_highlighting: false  # Enable search result highlighting
      default_size: 100  # Default number of results to return

    # Example fault tolerance settings (optional)
    fault_tolerance:
      operation_timeout: 30.0
      failure_threshold: 5
      recovery_timeout: 60.0
      max_retries: 3
      retry_delay: 1.0

  # HTTP JSON API Adapter - JSONPlaceholder (Simple Testing API)
  # This adapter uses a fake REST API for testing and debugging HTTP adapter functionality
  # No authentication required - perfect for isolating parameter extraction issues
  - name: "intent-http-jsonplaceholder"
    enabled: true
    type: "retriever"
    datasource: "http"  # Uses HTTP datasource placeholder
    adapter: "intent"
    implementation: "retrievers.implementations.intent.IntentHTTPJSONRetriever"
    inference_provider: "ollama_cloud"
    model: "gpt-oss:20b"
    embedding_provider: "ollama"
    embedding_model: "nomic-embed-text:latest"
    config:
      # Domain and template configuration
      domain_config_path: "utils/http-intent-template/examples/jsonplaceholder/templates/jsonplaceholder_domain.yaml"
      template_library_path:
        - "utils/http-intent-template/examples/jsonplaceholder/templates/jsonplaceholder_templates.yaml"

      # Vector store configuration for template matching
      template_collection_name: "jsonplaceholder_http_templates"
      store_name: "chroma"  # References stores.yaml

      # Intent matching configuration
      confidence_threshold: 0.4
      max_templates: 5
      return_results: 10
      verbose: false  # Enable debug logging

      # Template loading settings
      reload_templates_on_start: false
      force_reload_templates: false

      # HTTP-specific configuration
      base_url: "https://jsonplaceholder.typicode.com"
      default_timeout: 30
      enable_retries: true
      max_retries: 3
      retry_delay: 1.0

      # No authentication required for JSONPlaceholder

    # Fault tolerance settings
    fault_tolerance:
      operation_timeout: 30.0
      failure_threshold: 5
      recovery_timeout: 60.0
      max_retries: 3
      retry_delay: 1.0

  # HTTP JSON API Adapter - Paris Open Data (Que Faire à Paris)
  # This adapter queries the Paris city open data portal for events and activities
  # No authentication required - public API
  - name: "intent-http-paris-opendata"
    enabled: true
    type: "retriever"
    datasource: "http"  # Uses HTTP datasource placeholder
    adapter: "intent"
    implementation: "retrievers.implementations.intent.IntentHTTPJSONRetriever"
    inference_provider: "ollama_cloud"
    model: "gpt-oss:120b"
    embedding_provider: "ollama"
    config:
      # Domain and template configuration
      domain_config_path: "utils/http-intent-template/examples/paris-open-data/templates/paris_quoifaire_domain.yaml"
      template_library_path:
        - "utils/http-intent-template/examples/paris-open-data/templates/paris_quoifaire_templates.yaml"

      # Vector store configuration for template matching
      template_collection_name: "paris_opendata_http_templates"
      store_name: "chroma"  # References stores.yaml

      # Intent matching configuration
      confidence_threshold: 0.4
      max_templates: 5
      return_results: 20
      verbose: false  # Enable debug logging

      # Template loading settings
      reload_templates_on_start: true
      force_reload_templates: true

      # HTTP-specific configuration
      base_url: "https://opendata.paris.fr"
      default_timeout: 30
      enable_retries: true
      max_retries: 3
      retry_delay: 1.0

      # No authentication required for Paris Open Data

    # Fault tolerance settings
    fault_tolerance:
      operation_timeout: 30.0
      failure_threshold: 5
      recovery_timeout: 60.0
      max_retries: 3
      retry_delay: 1.0

  # Firecrawl Intent Adapter - Web Scraping with Intelligent Chunking
  # This adapter demonstrates web scraping using Firecrawl with natural language queries
  # Supports both cloud API (api.firecrawl.dev) and self-hosted Firecrawl deployments
  # Features intelligent content chunking for large documents (e.g., Wikipedia articles)
  - name: "intent-firecrawl-webscrape"
    enabled: false
    type: "retriever"
    datasource: "http"  # Reuse HTTP placeholder
    adapter: "intent"
    implementation: "retrievers.implementations.intent.IntentFirecrawlRetriever"
    inference_provider: "ollama_cloud"
    model: "gpt-oss:20b"
    embedding_provider: "ollama"  # Used for chunk ranking
    config:
      # TESTING: Using minimal templates for validation
      # Switch to firecrawl_domain.yaml and firecrawl_templates.yaml for full Wikipedia templates
      domain_config_path: "utils/firecrawl-intent-template/examples/web-scraping/templates/firecrawl_domain.yaml"
      template_library_path:
        - "utils/firecrawl-intent-template/examples/web-scraping/templates/firecrawl_templates.yaml"

      # Vector store for template matching
      template_collection_name: "firecrawl_test_templates"  # Using test collection name
      store_name: "chroma"

      # Intent matching (lower threshold for testing)
      confidence_threshold: 0.3
      max_templates: 5
      return_results: 1

      # Template loading
      reload_templates_on_start: false
      force_reload_templates: false

      # Enable verbose logging for debugging
      verbose: true

      # Firecrawl configuration
      # For cloud API: set base_url to https://api.firecrawl.dev/v1
      # For self-hosted: set to your instance URL
      base_url: "https://api.firecrawl.dev/v1"
      default_timeout: 60  # Increased for large pages
      default_formats: ["markdown"]

      # Authentication (for cloud API)
      auth:
        type: "bearer_token"
        token_env: "FIRECRAWL_API_KEY"
        header_name: "Authorization"
        token_prefix: "Bearer"

      # ========================================
      # Content Chunking Configuration
      # ========================================
      # Automatically chunks large web content to prevent exceeding LLM context limits
      # and improve response relevance through semantic search

      enable_chunking: true                    # Enable/disable chunking
      max_chunk_tokens: 4000                   # Maximum tokens per chunk (~16KB)
      chunk_overlap_tokens: 200                # Overlap between chunks for context continuity
      min_chunk_tokens: 500                    # Minimum chunk size

      # Embedding model limits (CRITICAL: Set based on your embedding provider)
      # OpenAI text-embedding-3-*: 8191 tokens → Use 7500 for safety
      # OpenAI text-embedding-ada-002: 8191 tokens → Use 7500 for safety
      # Cohere embed-english-v3.0: 512 tokens → Use 450 for safety!
      # Jina jina-embeddings-v3: 8192 tokens → Use 7500 for safety
      max_embedding_tokens: 7500               # Max tokens with safety buffer (accounts for estimation error)

      # Chunk storage and retrieval
      chunks_collection: "firecrawl_chunks"    # Vector store collection for chunks
      chunk_cache_ttl_hours: 24                # Cache duration (24 hours for Wikipedia)

      # Chunk ranking and selection
      top_chunks_to_return: 3                  # Number of most relevant chunks to return
      min_chunk_similarity: 0.3                # Minimum similarity score for chunk retrieval

      # Performance benefits:
      # - 75-90% reduction in context size
      # - Faster response times (cached chunks retrieved in <10ms)
      # - Better relevance (only return sections related to query)
      # - Cost optimization (fewer tokens processed by LLM)
      # - Automatic chunk splitting if content exceeds embedding limits
      # ========================================

    fault_tolerance:
      operation_timeout: 60.0  # Increased for large content
      failure_threshold: 5
      recovery_timeout: 60.0
      max_retries: 2
      retry_delay: 2.0

  # MongoDB Intent Retriever for Sample MFlix Database
  - name: "intent-mongodb-mflix"
    enabled: true
    type: "retriever"
    datasource: "mongodb"
    adapter: "intent"
    implementation: "retrievers.implementations.intent.intent_mongodb_retriever.IntentMongoDBRetriever"
    inference_provider: "ollama_cloud"
    model: "glm-4.7:cloud"
    embedding_provider: "openrouter"
    embedding_model: "openai/text-embedding-3-small"
    reranker_provider: "anthropic"
    capabilities:
      retrieval_behavior: "always"
      formatting_style: "standard"
      supports_file_ids: false
      supports_session_tracking: false
      supports_threading: true
      supports_autocomplete: true  # Enable autocomplete from template nl_examples
      requires_api_key_validation: true
    config:
      reranker_top_n: 10
      # Domain and template configuration
      domain_config_path: "utils/mongodb-intent-template/examples/sample_mflix/templates/mflix_domain.yaml"
      template_library_path:
        - "utils/mongodb-intent-template/examples/sample_mflix/templates/mflix_templates.yaml"
        - "utils/mongodb-intent-template/examples/sample_mflix/templates/mflix_advanced_templates.yaml"

      # Vector store configuration for template matching
      template_collection_name: "intent_mongodb_templates"
      store_name: "chroma"  # References stores.yaml

      # Intent matching configuration
      confidence_threshold: 0.4
      max_templates: 5
      return_results: 50

      # Template loading settings
      reload_templates_on_start: false
      force_reload_templates: false

      # MongoDB-specific configuration
      # Note: Connection parameters (connection_string, host, port, auth) are in datasources.yaml
      # Only adapter-specific settings go here
      database: "sample_mflix"  # Database name (can override datasource default)
      default_collection: "movies"  # Default collection for queries
      default_limit: 100  # Default number of results to return
      max_limit: 1000  # Maximum allowed limit
      enable_text_search: true  # Enable text search with regex
      case_insensitive_regex: true  # Case-insensitive regex by default

      # Placeholder base_url to satisfy parent class
      base_url: "http://localhost:27017"

    # Fault tolerance settings
    fault_tolerance:
      operation_timeout: 15.0
      failure_threshold: 10
      recovery_timeout: 30.0
      success_threshold: 5
      max_recovery_timeout: 120.0
      enable_exponential_backoff: true
      enable_thread_isolation: false
      enable_process_isolation: false
      max_retries: 3
      retry_delay: 1.0
      cleanup_interval: 3600.0
      retention_period: 86400.0
      event_handler:
        type: "default"

  # GraphQL Intent Adapter - SpaceX API
  # This adapter demonstrates GraphQL query generation from natural language
  # Uses the public SpaceX GraphQL API (no authentication required)
  - name: "intent-graphql-spacex"
    enabled: false
    type: "retriever"
    datasource: "http"  # Uses HTTP datasource placeholder
    adapter: "intent"
    implementation: "retrievers.implementations.intent.IntentGraphQLRetriever"
    inference_provider: "cohere"
    embedding_provider: "ollama"
    embedding_model: "nomic-embed-text:latest"
    config:
      # Domain and template configuration
      domain_config_path: "utils/graphql-intent-template/examples/spacex/templates/spacex_domain.yaml"
      template_library_path:
        - "utils/graphql-intent-template/examples/spacex/templates/spacex_templates.yaml"

      # Vector store configuration for template matching
      template_collection_name: "graphql_spacex_templates"
      store_name: "chroma"  # References stores.yaml

      # Intent matching configuration
      confidence_threshold: 0.4
      max_templates: 5
      return_results: 20

      # Template loading settings
      reload_templates_on_start: false
      force_reload_templates: false

      # GraphQL-specific configuration
      base_url: "https://spacex-production.up.railway.app"
      graphql_endpoint: "/graphql"
      supports_introspection: true
      default_timeout: 30
      enable_retries: true
      max_retries: 3
      retry_delay: 1.0

    # Fault tolerance settings
    fault_tolerance:
      operation_timeout: 30.0
      failure_threshold: 5
      recovery_timeout: 60.0
      max_retries: 3
      retry_delay: 1.0

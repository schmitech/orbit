# Composite Intent Retriever Adapters
# These adapters route queries across multiple intent adapters
# by searching templates across all sources and routing to the best match
#
# MULTI-STAGE SELECTION (Improved Accuracy)
# =========================================
# The composite retriever now supports multi-stage template selection to
# significantly improve accuracy when routing across many templates with
# similar vocabulary across different business domains.
#
# Multi-stage selection is configured GLOBALLY in config.yaml under
# the composite_retrieval section:
#
#   composite_retrieval:
#     reranking:
#       enabled: true              # Use LLM reranker for semantic refinement
#       provider: "anthropic"      # Reranker from rerankers.yaml
#       top_candidates: 10         # Candidates to rerank
#       weight: 0.4                # Weight in combined score
#     string_similarity:
#       enabled: true              # Use Jaro-Winkler/Levenshtein
#       algorithm: "jaro_winkler"  # Or "levenshtein"
#       weight: 0.2                # Weight in combined score
#     scoring:
#       embedding_weight: 0.4      # Weight for embedding similarity
#
# How it works:
#   Stage 1: Embedding search (current) - fast semantic matching
#   Stage 2: Reranking (optional) - LLM-based semantic refinement
#   Stage 3: String similarity (optional) - lexical matching for precision
#   Final: Combined score = weighted sum of all enabled stages
#
# Example: Query "Show all employees"
#   Without multi-stage: might match "Show all customers" (similar embedding)
#   With multi-stage: reranker and string similarity boost "employees" match

adapters:
  # Example: Multi-Source Data Explorer
  # Routes queries across HR, EV Population, and DuckDB Analytics databases
  - name: "composite-multi-source-explorer"
    enabled: false  # Enable when child adapters are configured
    type: "retriever"
    adapter: "composite"
    implementation: "retrievers.implementations.composite.CompositeIntentRetriever"
    inference_provider: "ollama_cloud"
    model: "gpt-oss:120b"
    # Shared embedding provider for consistent similarity scoring across sources
    embedding_provider: "ollama"
    embedding_model: "nomic-embed-text:latest"
    
    capabilities:
      retrieval_behavior: "always"
      formatting_style: "standard"
      supports_file_ids: false
      supports_session_tracking: false
      supports_threading: true
      requires_api_key_validation: true
      supports_autocomplete: true
    
    config:
      # Child adapters to search across
      # These must be names of other enabled intent adapters defined in intent.yaml
      child_adapters:
        - "intent-sql-sqlite-hr"
        - "intent-duckdb-ev-population"
        - "intent-duckdb-analytics"

      # Minimum confidence score to consider a template match
      confidence_threshold: 0.4

      # Maximum templates to retrieve from each child adapter
      max_templates_per_source: 3

      # Whether to search all sources in parallel (recommended for performance)
      parallel_search: true

      # Timeout for template search per source (seconds)
      search_timeout: 5.0

      # Enable verbose logging for debugging routing decisions
      verbose: false


  # Example: Full Multi-Database Explorer
  # Routes queries across SQL, DuckDB, MongoDB, and HTTP sources
  - name: "composite-full-explorer"
    enabled: false
    type: "retriever"
    adapter: "composite"
    implementation: "retrievers.implementations.composite.CompositeIntentRetriever"
    inference_provider: "ollama_cloud"
    model: "gpt-oss:120b"
    embedding_provider: "ollama"
    capabilities:
      retrieval_behavior: "always"
      formatting_style: "standard"
      supports_file_ids: false
      supports_session_tracking: false
      supports_threading: true
      requires_api_key_validation: true
      supports_autocomplete: true
    config:
      # Child adapters to search across
      child_adapters:
        # SQL databases
        - "intent-sql-sqlite-hr"
        # DuckDB databases
        - "intent-duckdb-analytics"
        - "intent-duckdb-ev-population"
        # MongoDB
        - "intent-mongodb-mflix"
        # HTTP APIs
        - "intent-http-paris-opendata"
        - "intent-http-jsonplaceholder"

      confidence_threshold: 0.35  # Lower threshold for diverse sources
      max_templates_per_source: 3
      parallel_search: true
      search_timeout: 8.0  # Higher timeout for HTTP sources
      verbose: true  # Enable verbose logging for debugging

  # Example: Government Data Explorer
  # Routes queries across multiple government open data sources
  - name: "composite-government-data"
    enabled: true  # Enable when child adapters are configured
    type: "retriever"
    adapter: "composite"
    implementation: "retrievers.implementations.composite.CompositeIntentRetriever"
    inference_provider: "ollama_cloud"
    model: "glm-4.7"
    embedding_provider: "ollama"
    embedding_model: "nomic-embed-text:latest"

    capabilities:
      retrieval_behavior: "always"
      formatting_style: "standard"
      supports_file_ids: false
      supports_session_tracking: false
      supports_threading: true
      supports_autocomplete: true  # Enable autocomplete from child adapter templates
      requires_api_key_validation: true

    config:
      # Child adapters to search across
      child_adapters:
        - "intent-duckdb-open-gov-travel-expenses"
        - "intent-duckdb-open-gov-contracts"
        - "intent-duckdb-open-gov-hospitality-expenses"

      confidence_threshold: 0.5
      max_templates_per_source: 5
      parallel_search: true
      search_timeout: 5.0
      verbose: false

        # Example: Government Data Explorer
  # Routes queries across multiple government open data sources
  - name: "composite-ottawa-police-data"
    enabled: true  # Enable when child adapters are configured
    type: "retriever"
    adapter: "composite"
    implementation: "retrievers.implementations.composite.CompositeIntentRetriever"
    inference_provider: "ollama_cloud"
    model: "gpt-oss:120b"
    embedding_provider: "ollama"
    embedding_model: "nomic-embed-text:latest"

    capabilities:
      retrieval_behavior: "always"
      formatting_style: "standard"
      supports_file_ids: false
      supports_session_tracking: false
      supports_threading: true
      supports_autocomplete: true  # Enable autocomplete from child adapter templates
      requires_api_key_validation: true

    config:
      # Child adapters to search across
      child_adapters:
        - "intent-duckdb-ottawa-police-auto-theft"
        - "intent-duckdb-ottawa-police-criminal-offences"

      confidence_threshold: 0.75
      max_templates_per_source: 5
      parallel_search: true
      search_timeout: 5.0
      verbose: false